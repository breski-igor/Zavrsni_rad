@model trainingAttendanceTracker.Models.MembershipFeeViewModel

@{
    ViewData["Title"] = "Membership Fee Management";
    var months = new[] { "Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec" };
}


<div class="mb-3 d-flex justify-content-between align-items-center">
    <h2 class="text-white mb-0">Membership Fee Management - @Model.Year</h2>

    <div>
        <label class="text-white me-2">Year:</label>
        <select id="yearSelect" class="form-select d-inline-block w-auto">
            @for (int y = DateTime.Now.Year - 1; y <= DateTime.Now.Year + 1; y++)
            {
                <option value="@y" selected="@(y == Model.Year)">@y</option>
            }
        </select>
    </div>
</div>


@if (Model.Members.Any())
{
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Member</th>
                    <th>Email</th>
                    @foreach (var month in months)
                    {
                        <th class="text-center">@month</th>
                    }
                </tr>
            </thead>
            <tbody>
                @foreach (var member in Model.Members)
                {
                    <tr>
                        <td>@member.FullName</td>
                        <td>@member.Email</td>
                        @for (int month = 0; month < 12; month++)
                        {
                            <td class="text-center">
                                <input type="checkbox"
                                       class="payment-checkbox"
                                       data-user-id="@member.UserId"
                                       data-month="@(month + 1)"
                                @(member.MonthlyPayments[month] ? "checked" : "")
                                @(User.IsInRole("Admin") ? "" : "disabled") />
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-info">
        No members found.
    </div>
}

@section Scripts {
    <script>
        document.getElementById('yearSelect').addEventListener('change', function () {
            window.location.href = '/Membership/Management?year=' + this.value;
        });

        document.querySelectorAll('.payment-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function () {
                const userId = this.dataset.userId;
                const month = parseInt(this.dataset.month);
                const year = @Model.Year;
                const isPaid = this.checked;

                fetch('/Membership/UpdatePayment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: userId,
                        year: year,
                        month: month,
                        isPaid: isPaid
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (!data.success) {
                            alert('Error updating payment: ' + data.error);
                            this.checked = !isPaid;
                        }
                    })
                    .catch(error => {
                        alert('Network error updating payment');
                        this.checked = !isPaid;
                    });
            });
        });
    </script>

    <style>
        .table {
            color: white !important;
            background-color: #222 !important;
        }

            .table td,
            .table th {
                color: white !important;
                border-color: #444 !important;
            }

            .table thead th {
                background-color: #333 !important;
                border-color: #444 !important;
            }

        .table-striped tbody tr:nth-of-type(odd) {
            background-color: #222 !important;
        }

        .table-striped tbody tr:nth-of-type(even) {
            background-color: #2a2a2a !important;
        }

        .table tbody tr:hover {
            background-color: #333 !important;
        }

        .payment-checkbox {
            transform: scale(1.2);
        }

        .alert {
            color: white !important;
        }

        .alert-info {
            background-color: #0dcaf0;
            border-color: #0dcaf0;
        }

    </style>
}