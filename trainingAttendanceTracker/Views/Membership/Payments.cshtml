@model trainingAttendanceTracker.Models.PaymentViewModel

@{
    ViewData["Title"] = "Payment Management";
    var totalIncome = Model.Payments.Where(p => p.PaymentType == trainingAttendanceTracker.Models.PaymentType.Income).Sum(p => p.Amount);
    var totalExpenses = Math.Abs(Model.Payments.Where(p => p.PaymentType == trainingAttendanceTracker.Models.PaymentType.Expense).Sum(p => p.Amount));
}

<h2>Payment Management</h2>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0">Filter by Date Range</h5>
    </div>
    <div class="card-body">
        <form method="get" asp-action="Payments" class="row g-3 align-items-end">
            <div class="col-md-5">
                <label class="form-label">Start Date</label>
                <div class="row g-2">
                    <div class="col-3">
                        <input type="number" name="startDay" class="form-control" placeholder="Dan"
                               min="1" max="31" value="@(Context.Request.Query["startDay"].ToString() != "" ? Context.Request.Query["startDay"] : "1")" />
                    </div>
                    <div class="col-5">
                        <select name="startMonth" class="form-select">
                            <option value="">Mjesec</option>
                            <option value="1" selected="@(Context.Request.Query["startMonth"] == "1")">Siječanj</option>
                            <option value="2" selected="@(Context.Request.Query["startMonth"] == "2")">Veljača</option>
                            <option value="3" selected="@(Context.Request.Query["startMonth"] == "3")">Ožujak</option>
                            <option value="4" selected="@(Context.Request.Query["startMonth"] == "4")">Travanj</option>
                            <option value="5" selected="@(Context.Request.Query["startMonth"] == "5")">Svibanj</option>
                            <option value="6" selected="@(Context.Request.Query["startMonth"] == "6")">Lipanj</option>
                            <option value="7" selected="@(Context.Request.Query["startMonth"] == "7")">Srpanj</option>
                            <option value="8" selected="@(Context.Request.Query["startMonth"] == "8")">Kolovoz</option>
                            <option value="9" selected="@(Context.Request.Query["startMonth"] == "9")">Rujan</option>
                            <option value="10" selected="@(Context.Request.Query["startMonth"] == "10")">Listopad</option>
                            <option value="11" selected="@(Context.Request.Query["startMonth"] == "11")">Studeni</option>
                            <option value="12" selected="@(Context.Request.Query["startMonth"] == "12")">Prosinac</option>
                        </select>
                    </div>
                    <div class="col-4">
                        <input type="number" name="startYear" class="form-control" placeholder="Godina"
                               min="2020" max="2030" value="@(Context.Request.Query["startYear"].ToString() != "" ? Context.Request.Query["startYear"] : DateTime.Now.Year.ToString())" />
                    </div>
                </div>
            </div>

            <div class="col-md-5">
                <label class="form-label">End Date</label>
                <div class="row g-2">
                    <div class="col-3">
                        <input type="number" name="endDay" class="form-control" placeholder="Dan"
                               min="1" max="31" value="@(Context.Request.Query["endDay"].ToString() != "" ? Context.Request.Query["endDay"] : DateTime.Now.Day.ToString())" />
                    </div>
                    <div class="col-5">
                        <select name="endMonth" class="form-select">
                            <option value="">Mjesec</option>
                            <option value="1" selected="@(Context.Request.Query["endMonth"] == "1")">Siječanj</option>
                            <option value="2" selected="@(Context.Request.Query["endMonth"] == "2")">Veljača</option>
                            <option value="3" selected="@(Context.Request.Query["endMonth"] == "3")">Ožujak</option>
                            <option value="4" selected="@(Context.Request.Query["endMonth"] == "4")">Travanj</option>
                            <option value="5" selected="@(Context.Request.Query["endMonth"] == "5")">Svibanj</option>
                            <option value="6" selected="@(Context.Request.Query["endMonth"] == "6")">Lipanj</option>
                            <option value="7" selected="@(Context.Request.Query["endMonth"] == "7")">Srpanj</option>
                            <option value="8" selected="@(Context.Request.Query["endMonth"] == "8")">Kolovoz</option>
                            <option value="9" selected="@(Context.Request.Query["endMonth"] == "9")">Rujan</option>
                            <option value="10" selected="@(Context.Request.Query["endMonth"] == "10")">Listopad</option>
                            <option value="11" selected="@(Context.Request.Query["endMonth"] == "11")">Studeni</option>
                            <option value="12" selected="@(Context.Request.Query["endMonth"] == "12")">Prosinac</option>
                        </select>
                    </div>
                    <div class="col-4">
                        <input type="number" name="endYear" class="form-control" placeholder="Godina"
                               min="2020" max="2030" value="@(Context.Request.Query["endYear"].ToString() != "" ? Context.Request.Query["endYear"] : DateTime.Now.Year.ToString())" />
                    </div>
                </div>
            </div>

            <div class="col-md-2">
                <button type="submit" class="btn btn-light btn-sm w-100">
                    <i class="fas fa-filter me-1"></i>Filter
                </button>
            </div>
        </form>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-info text-white h-100">
            <div class="card-body text-center d-flex flex-column justify-content-center">
                <h5 class="card-title">Other Income</h5>
                <h3 class="card-text">€@totalIncome.ToString("F2")</h3>
                <small class="mt-auto">Donations & Sponsors</small>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-danger text-white h-100">
            <div class="card-body text-center d-flex flex-column justify-content-center">
                <h5 class="card-title">Expenses</h5>
                <h3 class="card-text">€@totalExpenses.ToString("F2")</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card @(Model.NetBalance >= 0 ? "bg-primary" : "bg-warning") text-white h-100">
            <div class="card-body text-center d-flex flex-column justify-content-center">
                <h5 class="card-title">Net Balance</h5>
                <h3 class="card-text">€@Model.NetBalance.ToString("F2")</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-secondary text-white h-100">
            <div class="card-body text-center d-flex flex-column justify-content-center">
                <h5 class="card-title">Actions</h5>
                <div class="mt-auto">
                    <button class="btn btn-light btn-sm w-100" data-bs-toggle="modal" data-bs-target="#createPaymentModal">
                        <i class="fas fa-plus me-1"></i>Add Payment
                    </button>
                    <a asp-action="FinancialSummaryRange" class="btn btn-light btn-sm w-100 mt-1">
                        <i class="fas fa-chart-bar me-1"></i>Financial Report
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

@if (Model.Payments.Any())
{
    <div class="table-responsive">
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Type</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Amount</th>
                    <th>Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var payment in Model.Payments)
                {
                    <tr>
                        <td>@payment.PaymentDate.ToString("dd.MM.yyyy")</td>
                        <td>
                            @if (payment.PaymentType == trainingAttendanceTracker.Models.PaymentType.Income)
                            {
                                <span class="badge bg-success">Income</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">Expense</span>
                            }
                        </td>
                        <td>@payment.Description</td>
                        <td>
                            @if (!string.IsNullOrEmpty(payment.Category))
                            {
                                <span class="badge bg-secondary">@payment.Category</span>
                            }
                        </td>
                        <td class="@(payment.PaymentType == trainingAttendanceTracker.Models.PaymentType.Income ? "text-success fw-bold" : "text-danger fw-bold")">
                            @if (payment.PaymentType == trainingAttendanceTracker.Models.PaymentType.Income)
                            {
                                <text>+€@payment.Amount.ToString("F2")</text>
                            }
                            else
                            {
                                <text>-€@Math.Abs(payment.Amount).ToString("F2")</text>
                            }
                        </td>
                        <td>@payment.Notes</td>
                        <td>
                            <button class="btn btn-light btn-sm" onclick="deletePayment(@payment.Id, '@payment.Description')">
                                <i class="fas fa-trash me-1"></i>Delete
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-info">
        No payments recorded yet.
    </div>
}

<div class="modal fade" id="createPaymentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Payment/Income</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createPaymentForm">
                    <div class="mb-3">
                        <label class="form-label">Type *</label>
                        <select class="form-select" id="paymentType" name="paymentType" required>
                            <option value="0">Expense (Isplata)</option>
                            <option value="1">Income (Uplata)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description *</label>
                        <input type="text" class="form-control" id="description" name="description" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount (€) *</label>
                        <input type="number" class="form-control" id="amount" name="amount" step="0.01" min="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Payment Date *</label>
                        <input type="date" class="form-control" id="paymentDate" name="paymentDate" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Category</label>
                        <select class="form-select" id="category" name="category">
                            <option value="">Select Category</option>
                            <optgroup label="Expenses">
                                <option value="Rent">Rent</option>
                                <option value="Equipment">Equipment</option>
                                <option value="Utilities">Utilities</option>
                                <option value="Insurance">Insurance</option>
                                <option value="Salaries">Salaries</option>
                                <option value="Marketing">Marketing</option>
                                <option value="Other Expense">Other Expense</option>
                            </optgroup>
                            <optgroup label="Income">
                                <option value="Donation">Donation</option>
                                <option value="Sponsorship">Sponsorship</option>
                                <option value="Event Income">Event Income</option>
                                <option value="Merchandise">Merchandise</option>
                                <option value="Other Income">Other Income</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-toggle="modal">Cancel</button>
                <button type="button" class="btn btn-light" onclick="createPayment()">
                    <i class="fas fa-check me-1"></i>Create
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.getElementById('paymentDate').valueAsDate = new Date();

        function createPayment() {
            const formData = {
                description: document.getElementById('description').value,
                amount: parseFloat(document.getElementById('amount').value),
                paymentType: parseInt(document.getElementById('paymentType').value),
                paymentDate: document.getElementById('paymentDate').value,
                category: document.getElementById('category').value,
                notes: document.getElementById('notes').value
            };

            if (!formData.description || !formData.amount || !formData.paymentDate) {
                alert('Please fill in all required fields');
                return;
            }

            fetch('/Membership/CreatePayment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Payment created successfully');
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error creating payment');
                });
        }

        function deletePayment(paymentId, description) {
            if (!confirm(`Are you sure you want to delete: "${description}"?`)) {
                return;
            }

            fetch('/Membership/DeletePayment?id=' + paymentId, {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Payment deleted successfully');
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting payment');
                });
        }

        document.getElementById('paymentType').addEventListener('change', function () {
            const categorySelect = document.getElementById('category');
            if (this.value === '1') {
                if (!categorySelect.value) {
                    categorySelect.value = 'Donation';
                }
            } else {
                if (!categorySelect.value || categorySelect.value === 'Donation') {
                    categorySelect.value = 'Other Expense';
                }
            }
        });
    </script>

    <style>
        .table {
            color: white !important;
            background-color: #222 !important;
        }

            .table td,
            .table th {
                color: white !important;
                border-color: #444 !important;
            }

            .table thead th {
                background-color: #333 !important;
                border-color: #444 !important;
            }

        .table-striped tbody tr:nth-of-type(odd) {
            background-color: #222 !important;
        }

        .table-striped tbody tr:nth-of-type(even) {
            background-color: #2a2a2a !important;
        }

        .table tbody tr:hover {
            background-color: #333 !important;
        }



        .alert {
            color: white !important;
        }

        .alert-info {
            background-color: #0dcaf0;
            border-color: #0dcaf0;
        }
    </style>
}